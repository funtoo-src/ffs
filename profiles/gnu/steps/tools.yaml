tools:
  defaults:
    template: tools_gnu.tmpl
  steps:
    - none: |
        # A local 'patchelf' command is currently required for the final cross_tools to run
        which patchelf
    - gmp: |
        CC_FOR_BUILD=gcc \
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --enable-cxx
        make
        make install
    - mpfr: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - mpc: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - zlib: |
        unset CC CXX AR AS RANLIB LD STRIP
        CHOST=${CLFS_TARGET} \
        ./configure \
        --prefix=${CLFS}/tools
        make
        make install
    - binutils: |
        mkdir binutils-build && cd binutils-build
        ../configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --target=${CLFS_TARGET} \
        --with-lib-path=${CLFS}/tools/lib \
        --disable-nls \
        --enable-shared \
        --enable-64-bit-bfd \
        --disable-multilib \
        --enable-gold=yes \
        --enable-plugins \
        --with-system-zlib \
        --enable-threads
        make
        make install
    - gcc: |
        sed -i 's|^RAW_CXX_FOR_TARGET="$CXX_FOR_TARGET|& -nostdinc++|' configure
        mkdir gcc-build && cd gcc-build
        ../configure \
        {%- if arch == "powerpc" %}
        --with-abi=elfv2 \
        --enable-secureplt \
        --enable-decimal-float=no \
        {%- endif %}
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --target=${CLFS_TARGET} \
        CC_FOR_TARGET="${CLFS_TARGET}-gcc" \
        --with-build-sysroot=${CLFS} \
        --with-local-prefix=${CLFS}/tools \
        --disable-multilib \
        --enable-languages=c,c++ \
        --with-system-zlib \
        --with-native-system-header-dir=/tools/include \
        --disable-libssp \
        --enable-install-libiberty \
        --disable-libstdcxx-pch \
        --disable-libsanitizer
        make AS_FOR_TARGET="${AS}" \
        LD_FOR_TARGET="${LD}"
        make install
    - ncurses: |
        sed -i -e "s/INSTALL_OPT_S=\\\"-s/& --strip-program=${STRIP}/" configure
        mkdir ncurses-build && cd ncurses-build
        ../configure \
        --prefix=${CLFS}/tools \
        --with-shared \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --without-debug \
        --without-ada \
        --enable-overwrite \
        --with-build-cc=gcc \
        --enable-overwrite \
        --with-default-terminfo-dir=${CLFS}/tools/share/terminfo \
        --with-termlib
        make
        make install
        cd .. && mkdir ncursesw-build && cd ncursesw-build
        ../configure \
        --prefix=${CLFS}/tools \
        --with-shared \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --without-debug \
        --without-ada \
        --enable-overwrite \
        --with-build-cc=gcc \
        --enable-widec \
        --includedir=${CLFS}/tools/include/ncursesw \
        --with-default-terminfo-dir=${CLFS}/tools/share/terminfo \
        --with-termlib
        make
        make install
    - bash: |
        cat > config.cache << "BASH_EOF"
        ac_cv_func_mmap_fixed_mapped=yes
        ac_cv_func_strcoll_works=yes
        ac_cv_func_working_mktime=yes
        bash_cv_func_sigsetjmp=present
        bash_cv_getcwd_malloc=yes
        bash_cv_job_control_missing=present
        bash_cv_printf_a_format=yes
        bash_cv_sys_named_pipes=present
        bash_cv_ulimit_maxfds=yes
        bash_cv_under_sys_siglist=yes
        bash_cv_unusable_rtsigs=no
        gt_cv_int_divbyzero_sigfpe=yes
        BASH_EOF
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --without-bash-malloc \
        --cache-file=config.cache
        make
        make install
        test -x ${CLFS}/tools/bin/bash
        # set up initial shells in correct location for "#!/bin/sh" and "#!/bin/bash" scripts:
        rm -f ${CLFS}/bin/bash ${CLFS}/bin/sh || true
        ln -sf ../tools/bin/bash ${CLFS}/bin/bash
        ln -sf ../tools/bin/bash ${CLFS}/bin/sh
    - bzip2: |
        sed -i \
          -e '/^all/s/ test$//' \
          -e 's|CFLAGS=|&-fPIC |' \
        Makefile
        make CC="${CC}" AR="${AR}" RANLIB="${RANLIB}"
        make PREFIX=${CLFS}/tools install
    - check: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --disable-subunit
        make
        make install
    - coreutils: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --enable-install-program=hostname \
        --cache-file=config.cache
        sed -i -e 's/^man1_MANS/#man1_MANS/' Makefile
        make
        make install
    - diffutils: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - file: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --with-pic=yes
        make
        make install
    - findutils: |
        echo "gl_cv_func_wcwidth_works=yes" > config.cache
        echo "ac_cv_func_fnmatch_gnu=yes" >> config.cache
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --cache-file=config.cache
        make
        make install
    - gawk: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
#    - gettext: |
#        ./configure \
#        --prefix=${CLFS}/tools \
#        --build=${CLFS_HOST} \
#        --host=${CLFS_TARGET} \
#        --without-emacs \
#        --disable-threads \
#        --disable-shared
#        make
#        make install
    - grep: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - gzip: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - make: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --without-guile
        make
        make install
    - patch: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - sed: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - tar: |
        cat > config.cache << BASH_EOF
        gl_cv_func_wcwidth_works=yes
        gl_cv_func_btowc_eof=yes
        ac_cv_func_malloc_0_nonnull=yes
        gl_cv_func_mbrtowc_incomplete_state=yes
        gl_cv_func_mbrtowc_nul_retval=yes
        gl_cv_func_mbrtowc_null_arg1=yes
        gl_cv_func_mbrtowc_null_arg2=yes
        gl_cv_func_mbrtowc_retval=yes
        gl_cv_func_wcrtomb_retval=yes
        BASH_EOF
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --cache-file=config.cache
        make
        make install
    - util-linux: |
        NCURSESW6_CONFIG=" " \
        NCURSES6_CONFIG=" " \
        NCURSESW5_CONFIG=" " \
        NCURSES5_CONFIG=" " \
        LDFLAGS="-ltinfow" \
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --disable-bash-completion \
        --disable-makeinstall-chown \
        --disable-makeinstall-setuid \
        --disable-nologin \
        --without-python
        make
        make install
    - nano: |
        LDFLAGS="-ltinfow" \
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - xz-utils: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - which: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - none: |
        find "${CLFS}"/tools -type f -exec file {} + | \
          grep ELF | \
          cut -d':' -f1 | \
          xargs -I{} patchelf \
          --set-interpreter "${DYNAMIC_LINKER#$CLFS}" \
          --set-rpath /tools/lib/ {} 2>/dev/null || true
        find ${CLFS}/tools -iname '*.pc' -exec sed -i -e "s|${CLFS}||g" {} \; || true
        if [ ! -L "$CLFS/lib/ld-linux-{{gnu_arch}}.so.1" ]; then
          ln -sf ../tools/lib/ld-linux-{{gnu_arch}}.so.1 "$CLFS/lib/ld-linux-{{gnu_arch}}.so.1"
        fi

        cat > ${CLFS}/etc/profile << "PROFILE_EOF"
        # Funtoo from Scratch /etc/profile for login shells in the temporary environment.
        #
        # The following settings allow terminal-aware programs to find the terminal definitions
        # and also allow temporary tools to be found, while also allowing 'official' tools installed
        # in FHS-compliant paths to gradually replace these tools.

        export TERMINFO=/tools/share/terminfo
        export PATH=/bin:/usr/bin:/sbin:/usr/sbin:/tools/sbin:/tools/bin
        export HOME=/

        umask 022

        PROFILE_EOF
