fchroot:
  defaults:
    template: stage1.tmpl
  steps:
    - ego: |
        install -d /usr/share/ego
        cp -r modules* python /usr/share/ego/
        rm /usr/share/ego/modules*/upgrade*
        rm -rf /usr/share/ego/python/test
        chmod +x /usr/share/ego/modules/*.ego
        cp ego /tools/bin/
        ln -sf ego /tools/bin/epro
        ln -sf ego /tools/bin/edoc
        cat > /etc/ego.conf << "EGO_EOF"
        [global]
        release = 1.4
        EGO_EOF
        install -d /var/db/pkg/app-admin/ego-${EGO_VERSION}
        ego sync
    - none: |
        export PYTHON_ABIS="$(portageq envvar PYTHON_ABIS)"
        export FEATURES="-pid-sandbox nodoc noman noinfo"
        export ROOT=/tmp/stage1root
        # create symlink to real meta-repo to allow ego to pick up profiles inside ROOT...
        install -m 0755 -o 250 -g 250 -d $ROOT/var/git
        ln -s /var/git/meta-repo $ROOT/var/git/meta-repo
        ego profile mix-in +stage1
        # It's important to merge baselayout first so it can set perms on key dirs
        emerge --nodeps baselayout
        emerge --noreplace --oneshot \
          app-arch/bzip2 \
          app-arch/gzip \
          app-arch/tar \
          app-arch/xz-utils \
          app-shells/bash \
          net-misc/rsync \
          net-misc/wget \
          sys-devel/autoconf \
          sys-devel/automake \
          sys-devel/libtool \
          sys-apps/baselayout \
          sys-apps/coreutils \
          sys-apps/diffutils \
          sys-apps/file \
          sys-apps/findutils \
          sys-apps/gawk \
          sys-apps/grep \
          sys-apps/less \
          sys-apps/net-tools \
          sys-apps/sed \
          sys-apps/texinfo \
          sys-devel/binutils \
          sys-devel/bison \
          sys-devel/flex \
          sys-devel/gcc \
          sys-devel/gettext \
          sys-devel/gnuconfig \
          sys-devel/make \
          sys-devel/patch \
          sys-libs/pam \
          virtual/editor \
          virtual/libc \
          virtual/os-headers \
          virtual/package-manager \
          sys-apps/openrc
        gcc-config 1
        install -d ${ROOT}/{proc,sys,dev}
        ego profile mix-in -stage1

