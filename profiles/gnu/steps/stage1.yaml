fchroot:
  defaults:
    template: stage1.tmpl
  steps:
    - ego: |
        install -d /usr/share/ego
        cp -r modules* python /usr/share/ego/
        rm /usr/share/ego/modules*/upgrade*
        rm -rf /usr/share/ego/python/test
        chmod +x /usr/share/ego/modules/*.ego
        cp ego /usr/bin/
        ln -sf ego /usr/bin/epro
        ln -sf ego /usr/bin/edoc
        cat > /etc/ego.conf << "EGO_EOF"
        [global]
        release = next
        EGO_EOF
        install -d /var/db/pkg/app-admin/ego-${EGO_VERSION}
        ego sync
    - none: |
        export PYTHON_ABIS="$(portageq envvar PYTHON_ABIS)"
        export FEATURES="-pid-sandbox nodoc noman noinfo"
        export ROOT=/tmp/stage1root
        rm -rf $ROOT
        # work around an issue where split-usr is being unset.
        export USE="split-usr"
        install -m 0755 -d $ROOT/usr/bin
        install -m 0755 -d $ROOT/bin
        # also fix a lib issue -- did I miss some steps from metro?
        install -m 0755 -d $ROOT/lib64
        ln -sf lib64 $ROOT/lib
        install -d ${ROOT}/{proc,sys,dev}
        # create symlink to real meta-repo to allow ego to pick up profiles inside ROOT...
        install -m 0755 -o 250 -g 250 -d $ROOT/var/git
        install -d ${ROOT}/etc
        ln -sf /var/git/meta-repo $ROOT/var/git/
        ln -sf /etc/portage ${ROOT}/etc/
        ego profile mix-in +stage1
        # fix a circular dep
        install -d /var/db/pkg/sys-apps/openrc-9999
        # fix a required USE flag
        install -d /etc/portage/package.use
        echo "dev-libs/libxml2 python" > /etc/portage/package.use/libxml2
        # It's important to merge baselayout first so it can set perms on key dirs
        emerge --nodeps baselayout
        
        ldconfig
        /usr/sbin/env-update
        source /etc/profile

        emerge -u --noreplace --oneshot \
          --rebuild-exclude "sys-apps/openrc sys-libs/glibc net-misc/curl sys-devel/gcc" \
          elfutils
        #  app-arch/bzip2 \
        #  app-arch/gzip \
        #  app-arch/tar \
        #  app-arch/xz-utils \
        #  app-shells/bash \
        #  net-misc/rsync \
        #  net-misc/wget \
        #  sys-devel/autoconf \
        #  sys-devel/automake \
        #  sys-devel/libtool \
        #  sys-apps/coreutils \
        #  sys-apps/diffutils \
        #  sys-apps/file \
        #  sys-apps/findutils \
        #  sys-apps/gawk \
        #  sys-apps/grep \
        #  sys-apps/less \
        #  sys-apps/net-tools \
        #  sys-apps/sed \
        #  sys-apps/texinfo \
        #  sys-devel/binutils \
        #  sys-devel/bison \
        #  sys-devel/flex \
        #  sys-devel/gcc \
        #  sys-devel/gettext \
        #  sys-devel/gnuconfig \
        #  sys-devel/make \
        #  sys-devel/patch \
        #  sys-libs/pam \
        #  virtual/editor \
        #  virtual/libc \
        #  virtual/os-headers \
        #  virtual/package-manager \
        #  sys-apps/openrc
        gcc-config 1
        ego profile mix-in -stage1

