cross_tools:
  defaults:
    template: base.tmpl
  steps:
    - linux: |
        make mrproper
        make ARCH=${CLFS_ARCH} INSTALL_HDR_PATH=${CLFS}/tools headers_install
    - binutils: |
        mkdir binutils-build && cd binutils-build
        AR=ar AS=as ../configure \
          --prefix=${CLFS}/cross-tools \
          --host=${CLFS_HOST} \
          --target=${CLFS_TARGET} \
          --with-sysroot=${CLFS} \
          --with-lib-path=${CLFS}/tools/lib \
          --disable-nls \
          --disable-static \
          --enable-64-bit-bfd \
          --disable-multilib \
          --disable-werror
        make
        make install
    - gmp: |
        ./configure \
          --prefix=${CLFS}/cross-tools \
          --enable-cxx \
          --disable-static
        make
        make install
        make check
    - mpfr: |
        LDFLAGS="-Wl,-rpath,${CLFS}/cross-tools/lib" ./configure \
          --prefix=${CLFS}/cross-tools \
          --disable-static \
          --with-gmp=${CLFS}/cross-tools
        make
        make install
    - mpc: |
        LDFLAGS="-Wl,-rpath,${CLFS}/cross-tools/lib" ./configure \
          --prefix=${CLFS}/cross-tools \
          --disable-static \
          --with-mpfr=${CLFS}/cross-tools
        make
        make install
    - gcc: |
        mkdir gcc-build && cd gcc-build
        AR=ar LDFLAGS="-Wl,-rpath,${CLFS}/cross-tools/lib" \
          ../configure \
          --prefix=${CLFS}/cross-tools \
          --build=${CLFS_HOST} \
          --host=${CLFS_HOST} \
          --target=${CLFS_TARGET} \
          --with-sysroot=${CLFS} \
          --with-local-prefix=${CLFS}/tools \
          --with-native-system-header-dir=/tools/include \
          --disable-shared \
          --without-headers \
          --with-newlib \
          --disable-decimal-float \
          --disable-libgomp \
          --disable-libssp \
          --disable-libatomic \
          --disable-libitm \
          --disable-libsanitizer \
          --disable-libquadmath \
          --disable-libvtv \
          --disable-libcilkrts \
          --disable-libstdc++-v3 \
          --disable-threads \
          --disable-multilib \
          --enable-languages=c \
          --with-mpfr=${CLFS}/cross-tools \
          --with-gmp=${CLFS}/cross-tools \
          --with-mpc=${CLFS}/cross-tools
        make all-gcc all-target-libgcc
        make install-gcc install-target-libgcc
    - musl: |
        CC="${CLFS_TARGET}-gcc ${CLFS_CFLAGS}" \
          ./configure \
          CROSS_COMPILE=${CLFS_TARGET}- \
          --prefix=/ \
          --target=${CLFS_TARGET}
        make
        DESTDIR=${CLFS}/tools make install
        cd "${CLFS}"/tools/lib
        unlink ld-musl-aarch64.so.1
        ln -sf libc.so ld-musl-aarch64.so.1
        ls -la ld-musl-aarch64.so.1
        find -type f \
          -iname 'crt*.o' \
          -exec ln -sf ../../../tools/lib/{} "${CLFS}"/cross-tools/"${CLFS_TARGET}"/lib/{} \;
    - gcc: |
        mkdir gcc-build && cd gcc-build
        AR=ar LDFLAGS="-Wl,-rpath,${CLFS}/cross-tools/lib" \
          ../configure \
          --prefix=${CLFS}/cross-tools \
          --build=${CLFS_HOST} \
          --target=${CLFS_TARGET} \
          --host=${CLFS_HOST} \
          --with-sysroot=${CLFS} \
          --with-local-prefix=${CLFS}/tools \
          --with-native-system-header-dir=/tools/include \
          --with-lib-path=${CLFS}/tools/lib \
          --disable-nls \
          --disable-static \
          --enable-languages=c,c++ \
          --disable-multilib \
          --disable-libsanitizer \
          --with-mpfr=${CLFS}/cross-tools \
          --with-gmp=${CLFS}/cross-tools \
          --with-mpc=${CLFS}/cross-tools
        make AS_FOR_TARGET="${CLFS_TARGET}-as" \
          LD_FOR_TARGET="${CLFS_TARGET}-ld"
        make install

tools:
  defaults:
    template: tools.tmpl
  steps:
    - gmp: |
        CC_FOR_BUILD=gcc \
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --enable-cxx
        make
        make install
    - mpfr: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - mpc: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - isl: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - zlib: |
        ./configure \
        --prefix=${CLFS}/tools
        make
        make install
    - binutils: |
        mkdir binutils-build && cd binutils-build
        ../configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --target=${CLFS_TARGET} \
        --with-lib-path=${CLFS}/tools/lib \
        --disable-nls \
        --enable-shared \
        --enable-64-bit-bfd \
        --disable-multilib \
        --enable-gold=yes \
        --enable-plugins \
        --with-system-zlib \
        --enable-threads
        make
        make install
    - gcc: |
        sed -i 's|^RAW_CXX_FOR_TARGET="$CXX_FOR_TARGET|& -nostdinc++|' configure
        mkdir gcc-build && cd gcc-build
        ../configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --target=${CLFS_TARGET} \
        --with-local-prefix=${CLFS}/tools \
        --disable-multilib \
        --enable-languages=c,c++ \
        --with-system-zlib \
        --with-native-system-header-dir=/tools/include \
        --disable-libssp \
        --enable-install-libiberty \
        --disable-libstdcxx-pch \
        --disable-libsanitizer
        make AS_FOR_TARGET="${AS}" \
        LD_FOR_TARGET="${LD}"
        make install
    - ncurses: |
        sed -i -e "s/INSTALL_OPT_S=\\\"-s/& --strip-program=${STRIP}/" configure
        mkdir ncurses-build && cd ncurses-build
        ../configure \
        --prefix=${CLFS}/tools \
        --with-shared \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --without-debug \
        --without-ada \
        --enable-overwrite \
        --with-build-cc=gcc \
        --enable-overwrite \
        --with-default-terminfo-dir=${CLFS}/tools/share/terminfo \
        --with-termlib
        make
        make install
        cd .. && mkdir ncursesw-build && cd ncursesw-build
        ../configure \
        --prefix=${CLFS}/tools \
        --with-shared \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --without-debug \
        --without-ada \
        --enable-overwrite \
        --with-build-cc=gcc \
        --enable-widec \
        --includedir=${CLFS}/tools/include/ncursesw \
        --with-default-terminfo-dir=${CLFS}/tools/share/terminfo \
        --with-termlib
        make
        make install
    - bash: |
        cat > config.cache << "EOF"
        ac_cv_func_mmap_fixed_mapped=yes
        ac_cv_func_strcoll_works=yes
        ac_cv_func_working_mktime=yes
        bash_cv_func_sigsetjmp=present
        bash_cv_getcwd_malloc=yes
        bash_cv_job_control_missing=present
        bash_cv_printf_a_format=yes
        bash_cv_sys_named_pipes=present
        bash_cv_ulimit_maxfds=yes
        bash_cv_under_sys_siglist=yes
        bash_cv_unusable_rtsigs=no
        gt_cv_int_divbyzero_sigfpe=yes
        EOF
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --without-bash-malloc \
        --cache-file=config.cache
        make
        make install
    - bzip2: |
        sed -i \
          -e '/^all/s/ test$//' \
          -e 's|CFLAGS=|&-fPIC |' \
        Makefile
        make CC="${CC}" AR="${AR}" RANLIB="${RANLIB}"
        make PREFIX=${CLFS}/tools install
    - check: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --disable-subunit
        make
        make install
    - coreutils: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --enable-install-program=hostname \
        --cache-file=config.cache
        sed -i -e 's/^man1_MANS/#man1_MANS/' Makefile
        make
        make install
    - diffutils: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - file: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --with-pic=yes
        make
        make install
    - findutils: |
        echo "gl_cv_func_wcwidth_works=yes" > config.cache
        echo "ac_cv_func_fnmatch_gnu=yes" >> config.cache
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --cache-file=config.cache
        make
        make install
    - gawk: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - gettext: |
        EMACS="no" \
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --disable-shared
        make
        make install
    - grep: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - gzip: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - make: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --without-guile
        make
        make install
    - patch: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - sed: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - tar: |
        cat > config.cache << EOF
        gl_cv_func_wcwidth_works=yes
        gl_cv_func_btowc_eof=yes
        ac_cv_func_malloc_0_nonnull=yes
        gl_cv_func_mbrtowc_incomplete_state=yes
        gl_cv_func_mbrtowc_nul_retval=yes
        gl_cv_func_mbrtowc_null_arg1=yes
        gl_cv_func_mbrtowc_null_arg2=yes
        gl_cv_func_mbrtowc_retval=yes
        gl_cv_func_wcrtomb_retval=yes
        EOF 
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --cache-file=config.cache
        make
        make install
    - texinfo: |
        PERL=/usr/bin/perl \
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - util-linux: |
        NCURSESW6_CONFIG=" " \
        NCURSES6_CONFIG=" " \
        NCURSESW5_CONFIG=" " \
        NCURSES5_CONFIG=" " \
        LDFLAGS="-ltinfow" \
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET} \
        --disable-bash-completion \
        --disable-makeinstall-chown \
        --disable-makeinstall-setuid \
        --disable-nologin \
        --without-python
        make
        make install
    - nano: |
        LDFLAGS="-ltinfow" \
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
    - xz-utils: |
        ./configure \
        --prefix=${CLFS}/tools \
        --build=${CLFS_HOST} \
        --host=${CLFS_TARGET}
        make
        make install
